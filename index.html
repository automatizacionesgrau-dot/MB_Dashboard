<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Solutions 4 Home - Dashboard Profesional (Depurado)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --purple: #8e44ad;
            --orange: #e67e22;
            --teal: #16a085;
            --pink: #e91e63;
            --indigo: #3f51b5;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #e0e0e0;
            --shadow: rgba(60, 64, 67, 0.3);
            --shadow-light: rgba(60, 64, 67, 0.08);
            --shadow-medium: rgba(60, 64, 67, 0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-card: #2a2a2a;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border: #3c4043;
            --shadow: rgba(0, 0, 0, 0.5);
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            padding: 16px 32px;
            box-shadow: 0 2px 8px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 24px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-light);
            border-color: var(--primary);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Interactive Stats Cards */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px var(--shadow-light);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
        }

        .stat-card::after {
            content: 'üëÜ Click para detalles';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 24px var(--shadow-medium);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-card:active {
            transform: translateY(-4px) scale(0.98);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-content h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 12px;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Tabs */
        .tabs-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 2px 8px var(--shadow-light);
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            position: relative;
        }

        .tabs-container::before {
            content: 'üëá Selecciona una secci√≥n';
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -5px); }
        }

        .tab {
            flex: 1;
            padding: 18px 24px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .tab:hover::before {
            opacity: 1;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
            transform: scale(1.05);
        }

        .tab.active::before {
            opacity: 0;
        }

        .tab-icon {
            font-size: 22px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 8px var(--shadow-light);
            transition: all 0.3s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Storage Visualization */
        .storage-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .storage-stats {
            display: flex;
            gap: 24px;
        }

        .storage-stat-item {
            display: flex;
            flex-direction: column;
        }

        .storage-stat-item label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .storage-stat-item span {
            font-size: 24px;
            font-weight: 700;
        }

        .storage-visual {
            display: flex;
            height: 200px;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .storage-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s;
            cursor: pointer;
            height: 100%;
        }
        
        .storage-section:hover .storage-project-block {
            transform: scale(1.05);
            box-shadow: 0 8px 24px var(--shadow-medium);
            z-index: 10;
        }

        .storage-project-block {
            flex: 1;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-align: center;
            padding: 8px;
            line-height: 1.2;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            margin: 4px;
        }

        .storage-project-block::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .storage-project-block:hover::before {
            opacity: 1;
        }

        .storage-empty {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s;
            position: relative;
        }
        
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }


        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .material-list {
            display: grid;
            gap: 8px;
        }

        .material-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
        }

        .material-name {
            font-weight: 500;
        }

        .material-quantity {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Transport Schedule */
        .transport-schedule {
            overflow-x: auto;
            margin-bottom: 24px;
        }

        .schedule-day {
            margin-bottom: 20px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: 80px repeat(24, 1fr);
            gap: 2px;
            min-width: 1200px;
        }

        .hour-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .hour-cell {
            height: 40px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .hour-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .hour-free {
            background: rgba(52, 168, 83, 0.2);
            border: 1px solid var(--success);
        }

        .hour-busy-own {
            background: rgba(26, 115, 232, 0.3);
            border: 1px solid var(--primary);
        }

        .hour-busy-rental {
            background: rgba(234, 67, 53, 0.3);
            border: 1px solid var(--danger);
        }

        .rental-companies {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .rental-company-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .rental-company-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow-medium);
            border-color: var(--primary);
        }

        .rental-company-card.clickable::after {
            content: 'üîç Ver precios';
            display: block;
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
        }

        .company-logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .company-prices {
            display: grid;
            gap: 8px;
            margin-top: 12px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
        }

        /* Timeline */
        .timeline-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .timeline-legend {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .timeline-grid {
            position: relative;
            min-width: 1400px;
        }

        .timeline-months {
            display: grid;
            grid-template-columns: 100px repeat(24, 1fr);
            gap: 4px;
            margin-bottom: 12px;
        }

        .month-label {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .timeline-today-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            z-index: 100;
            animation: pulse-line 2s ease-in-out infinite;
        }

        @keyframes pulse-line {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timeline-today-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .timeline-row {
            display: grid;
            grid-template-columns: 100px repeat(24, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .project-label {
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            padding-right: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-bar-container {
            grid-column: span 24;
            position: relative;
            height: 40px;
        }

        .project-bar {
            position: absolute;
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            white-space: nowrap;
        }

        .project-bar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            to { transform: translateX(100%); }
        }

        .project-bar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .project-status-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 9px;
            margin-left: 12px;
            flex-shrink: 0;
        }

        /* Chat */
        .chat-sidebar {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 2px 8px var(--shadow-light);
            display: flex;
            flex-direction: column;
            height: 800px;
            position: sticky;
            top: 100px;
        }

        .chat-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageSlide 0.3s ease-out;
            word-wrap: break-word;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            font-weight: 500;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            max-width: 70px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 13px;
            border: 1px solid var(--border);
        }

        .file-remove {
            margin-left: auto;
            cursor: pointer;
            color: var(--danger);
            font-weight: bold;
            transition: transform 0.2s;
        }

        .file-remove:hover {
            transform: scale(1.2);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 4px;
            transition: all 0.3s;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .file-input-label {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
            flex-shrink: 0;
        }

        .file-input-label:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1) rotate(10deg);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px;
            font-size: 14px;
            color: var(--text-primary);
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
            animation: placeholderPulse 3s ease-in-out infinite;
        }

        @keyframes placeholderPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        /* Workers */
        .province-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .province-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .province-header:hover {
            background: var(--bg-card);
        }

        .province-name {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .province-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }

        .expand-icon {
            transition: transform 0.3s;
            font-size: 20px;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .workers-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .workers-list.expanded {
            max-height: 3000px;
        }

        .worker-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .worker-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .worker-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .worker-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .worker-details h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .worker-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .worker-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            text-align: right;
        }

        .availability-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-available {
            background: rgba(52, 168, 83, 0.15);
            color: var(--success);
        }

        .badge-busy {
            background: rgba(234, 67, 53, 0.15);
            color: var(--danger);
        }

        .worker-rate {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-color: transparent;
            color: white;
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--text-primary);
            color: var(--bg-card);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        @media (max-width: 768px) {
            .stats-overview { grid-template-columns: 1fr; }
            .storage-visual { flex-direction: column; height: auto; }
            .hours-grid { grid-template-columns: 60px repeat(24, 1fr); }
            .chat-sidebar { height: 600px; }
            .province-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .worker-card { flex-direction: column; align-items: flex-start; gap: 12px; }
            .worker-status { flex-direction: row; justify-content: space-between; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">MB</div>
            <span>MB Solutions 4 Home</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">üåô</span>
            <span id="theme-text">Modo Oscuro</span>
        </button>
    </div>

    <div class="container">
        <!-- Interactive Stats Cards -->
        <div class="stats-overview">
            <div class="stat-card" onclick="openStorageDetails()">
                <div class="stat-header">
                    <div class="stat-content">
                        <h3>Almacenamiento</h3>
                        <div class="stat-value" id="stat-storage-value">...</div>
                        <div class="stat-subtitle" id="stat-storage-subtitle">...</div>
                        <div class="stat-trend trend-up">
                            <span>‚Üë 12%</span>
                            <span style="color: var(--text-secondary);">vs. mes anterior</span>
                        </div>
                    </div>
                    <div class="stat-icon" style="background: rgba(26, 115, 232, 0.1); color: var(--primary);">üì¶</div>
                </div>
            </div>

            <div class="stat-card" onclick="openWorkersDetails()">
                <div class="stat-header">
                    <div class="stat-content">
                        <h3>Personal Activo</h3>
                        <div class="stat-value" id="stat-workers-value">...</div>
                        <div class="stat-subtitle" id="stat-workers-subtitle">...</div>
                        <div class="stat-trend trend-down">
                            <span id="stat-workers-trend-val">...</span>
                            <span style="color: var(--text-secondary);" id="stat-workers-trend-text">...</span>
                        </div>
                    </div>
                    <div class="stat-icon" style="background: rgba(52, 168, 83, 0.1); color: var(--success);">üë∑</div>
                </div>
            </div>

            <div class="stat-card" onclick="openTransportDetails()">
                <div class="stat-header">
                    <div class="stat-content">
                        <h3>Transporte</h3>
                        <div class="stat-value" style="font-size: 24px;">85%</div>
                        <div class="stat-subtitle">ocupaci√≥n mensual</div>
                        <div class="stat-trend trend-up">
                            <span>‚Üë 18 d√≠as</span>
                            <span style="color: var(--text-secondary);">este mes</span>
                        </div>
                    </div>
                    <div class="stat-icon" style="background: rgba(251, 188, 4, 0.1); color: var(--warning);">üöö</div>
                </div>
            </div>

            <div class="stat-card" onclick="openBillingDetails()">
                <div class="stat-header">
                    <div class="stat-content">
                        <h3>Facturaci√≥n</h3>
                        <div class="stat-value" style="font-size: 28px;">8.450‚Ç¨</div>
                        <div class="stat-subtitle">ingresos mensuales</div>
                        <div class="stat-trend trend-up">
                            <span>‚Üë 24%</span>
                            <span style="color: var(--text-secondary);">vs. mes anterior</span>
                        </div>
                    </div>
                    <div class="stat-icon" style="background: rgba(234, 67, 53, 0.1); color: var(--danger);">üí∞</div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <div class="card-title-icon" style="background: rgba(142, 68, 173, 0.1); color: var(--purple);">üìÖ</div>
                    Timeline de Proyectos 2024-2026
                </h2>
            </div>
            <div class="timeline-container">
                <div class="timeline-header">
                    <div style="font-weight: 600;">Proyectos completados, en curso y programados</div>
                    <div class="timeline-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--success);"></div>
                            <span>Completado</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--primary);"></div>
                            <span>En curso</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--warning);"></div>
                            <span>Programado</span>
                        </div>
                    </div>
                </div>
                <div class="timeline-grid" id="timeline-grid"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab active" data-tab="almacenamiento" onclick="switchTab('almacenamiento', this)">
                <span class="tab-icon">üì¶</span>
                Almacenamiento
            </button>
            <button class="tab" data-tab="transporte" onclick="switchTab('transporte', this)">
                <span class="tab-icon">üöö</span>
                Transporte
            </button>
            <button class="tab" data-tab="industriales" onclick="switchTab('industriales', this)">
                <span class="tab-icon">üë∑</span>
                Industriales
            </button>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <div class="main-content">
                <!-- Tab: Almacenamiento -->
                <div id="tab-almacenamiento" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <div class="card-title-icon" style="background: rgba(26, 115, 232, 0.1); color: var(--primary);">üìä</div>
                                Distribuci√≥n de Almac√©n
                            </h2>
                        </div>
                        <div id="storage-visualization"></div>
                    </div>
                </div>

                <!-- Tab: Transporte -->
                <div id="tab-transporte" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <div class="card-title-icon" style="background: rgba(251, 188, 4, 0.1); color: var(--warning);">üïê</div>
                                Horarios de Transporte
                            </h2>
                        </div>
                        <div id="transport-schedule"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <div class="card-title-icon" style="background: rgba(230, 126, 34, 0.1); color: var(--orange);">üöê</div>
                                Empresas de Alquiler
                            </h2>
                        </div>
                        <div id="rental-companies"></div>
                    </div>
                </div>

                <!-- Tab: Industriales -->
                <div id="tab-industriales" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <div class="card-title-icon" style="background: rgba(52, 168, 83, 0.1); color: var(--success);">üó∫Ô∏è</div>
                                Personal por Provincia
                            </h2>
                        </div>
                        
                        <div class="filter-bar">
                            <button class="filter-btn active" onclick="filterWorkers(this, 'all')">Todos</button>
                            <button class="filter-btn" onclick="filterWorkers(this, 'available')">Disponibles</button>
                            <button class="filter-btn" onclick="filterWorkers(this, 'busy')">Ocupados</button>
                        </div>

                        <div id="workers-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Sidebar -->
            <div class="chat-sidebar">
                <div class="chat-header">
                    <h3>üí¨ Asistente IA</h3>
                    <div class="chat-subtitle">Consulta recursos, proyectos y costes en tiempo real</div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant">
                        <div>¬°Hola! üëã Soy tu asistente de gesti√≥n inteligente.</div>
                        <div style="margin-top: 12px;">Puedo ayudarte con:</div>
                        <div style="margin-top: 8px; line-height: 1.8;">
                            ‚Ä¢ Consultar disponibilidad de recursos<br>
                            ‚Ä¢ Gestionar proyectos y clientes<br>
                            ‚Ä¢ Calcular costes y presupuestos<br>
                            ‚Ä¢ Analizar propuestas<br>
                            ‚Ä¢ Asignar personal a proyectos
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(26, 115, 232, 0.1); border-radius: 8px; font-size: 12px;">
                            üí° <strong>Prueba a escribir:</strong><br>
                            "¬øCu√°ntos electricistas tenemos en Barcelona?"<br>
                            "Mu√©strame el desglose financiero"<br>
                            "¬øQu√© proyectos est√°n activos?"
                        </div>
                        <div class="message-time" id="init-time"></div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div id="file-preview-container"></div>
                    <div class="chat-input-wrapper">
                        <label for="file-upload" class="file-input-label">üìé</label>
                        <input type="file" id="file-upload" accept=".pdf,.txt,.doc,.docx" onchange="handleFileSelect(event)">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="Escribe tu consulta aqu√≠... (ej: ¬øCu√°ntos electricistas tenemos en Barcelona?)"
                            rows="1"
                            onkeypress="handleKeyPress(event)"
                        ></textarea>
                        <button class="send-button" onclick="sendMessage()" id="send-button">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('project-modal')">√ó</button>
            <div class="modal-header">
                <h2 class="modal-title" id="modal-project-title"></h2>
                <div class="modal-subtitle" id="modal-project-client"></div>
            </div>
            <div id="modal-project-content"></div>
        </div>
    </div>

    <div id="rental-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('rental-modal')">√ó</button>
            <div class="modal-header">
                <h2 class="modal-title" id="modal-rental-title"></h2>
                <div class="modal-subtitle">Precios actualizados - Noviembre 2025</div>
            </div>
            <div id="modal-rental-content"></div>
        </div>
    </div>

    <script>
        // =================================================================================
        // VARIABLE GLOBAL DE FECHA Y DATOS
        // =================================================================================

        // Se fija una fecha "actual" para que todos los datos (proyectos, trabajadores, etc.)
        // sean coherentes y din√°micos respecto a esta fecha.
        const TODAY = new Date('2025-11-07T10:00:00');

        // Datos enriquecidos de Proyectos
        const projects = [
            {
                id: 1,
                name: 'Reforma Oficinas Tech Park',
                client: 'Construcciones Mart√≠nez',
                color: '#1a73e8',
                storage: 8,
                materials: [
                    { name: 'Pintura oficinas', quantity: '95L' },
                    { name: 'Tabiquer√≠a ligera', quantity: '42m¬≤' },
                    { name: 'Cableado red datos', quantity: '250m' }
                ],
                startDate: '2024-09-01',
                endDate: '2024-10-30',
                financials: { contractValue: 22000, projectedCost: 18000, actualCost: 17500 },
                team: [
                    { role: 'Jefe de Obra', name: 'Ricardo P.' },
                    { role: 'Electricista', count: 2 },
                    { role: 'Pintor', count: 2 }
                ]
            },
            {
                id: 2,
                name: 'Vivienda Eixample',
                client: 'Reformas Vila S.L.',
                color: '#8e44ad',
                storage: 12,
                materials: [
                    { name: 'Azulejos ba√±o/cocina', quantity: '85m¬≤' },
                    { name: 'Grifer√≠a completa', quantity: '8 unidades' },
                    { name: 'Sanitarios', quantity: '3 juegos' }
                ],
                startDate: '2024-10-15',
                endDate: '2025-01-10',
                financials: { contractValue: 45000, projectedCost: 38000, actualCost: 39500 },
                team: [
                    { role: 'Alba√±il', count: 3 },
                    { role: 'Fontanero', count: 2 },
                    { role: 'Pintor', count: 2 }
                ]
            },
            {
                id: 3,
                name: 'Reforma Integral c/ Diagonal 420',
                client: 'Construcciones Mart√≠nez',
                color: '#1a73e8',
                storage: 18,
                materials: [
                    { name: 'Cemento y mortero', quantity: '450kg' },
                    { name: 'Ladrillos cer√°micos', quantity: '2.500 unidades' },
                    { name: 'Tuber√≠a cobre/PVC', quantity: '180m' }
                ],
                startDate: '2024-11-01',
                endDate: '2025-03-20',
                financials: { contractValue: 110000, projectedCost: 90000, actualCost: 92000 },
                team: [
                    { role: 'Jefe de Obra', name: 'Ana G.' },
                    { role: 'Alba√±il', count: 5 },
                    { role: 'Fontanero', count: 2 },
                    { role: 'Electricista', count: 2 }
                ]
            },
            {
                id: 4,
                name: 'Apartamentos Platja d\'Aro',
                client: 'Inmobiliaria Costa Brava',
                color: '#e67e22',
                storage: 15,
                materials: [
                    { name: 'Cemento Portland', quantity: '600kg' },
                    { name: 'Aislante t√©rmico', quantity: '150m¬≤' },
                    { name: 'Impermeabilizante', quantity: '100L' }
                ],
                startDate: '2025-01-15',
                endDate: '2025-06-30',
                financials: { contractValue: 180000, projectedCost: 150000, actualCost: 152000 },
                team: [
                    { role: 'Jefe de Obra', name: 'Carlos R.' },
                    { role: 'Alba√±il', count: 4 },
                    { role: 'Carpintero', count: 3 }
                ]
            },
            {
                id: 5,
                name: 'Loft Sant Antoni',
                client: 'Arquitectura Moderna BCN',
                color: '#16a085',
                storage: 10,
                materials: [
                    { name: 'Tarima flotante', quantity: '95m¬≤' },
                    { name: 'Paneles decorativos', quantity: '60m¬≤' }
                ],
                startDate: '2025-03-01',
                endDate: '2025-05-30',
                financials: { contractValue: 35000, projectedCost: 28000, actualCost: 27500 },
                team: [
                    { role: 'Electricista', count: 1 },
                    { role: 'Pintor', count: 2 },
                    { role: 'Pe√≥n', count: 1 }
                ]
            },
            {
                id: 6,
                name: 'Local Comercial Raval',
                client: 'Proyectos Sagrada SL',
                color: '#e91e63',
                storage: 5,
                materials: [
                    { name: 'Pintura satinada', quantity: '50L' },
                    { name: 'Iluminaci√≥n comercial', quantity: '20 focos' }
                ],
                startDate: '2025-05-01',
                endDate: '2025-06-15',
                financials: { contractValue: 18000, projectedCost: 14000, actualCost: 13800 },
                team: [
                    { role: 'Electricista', count: 1 },
                    { role: 'Pintor', count: 1 }
                ]
            },
            {
                id: 7,
                name: 'Residencial Les Corts',
                client: 'Construcciones Mart√≠nez',
                color: '#1a73e8',
                storage: 20, // Materiales asignados para proyecto activo
                materials: [
                    { name: 'Hormig√≥n premezclado', quantity: '15m¬≥' },
                    { name: 'Acero corrugado', quantity: '1.200kg' },
                    { name: 'Bloques de hormig√≥n', quantity: '3.000 unidades' }
                ],
                startDate: '2025-07-01',
                endDate: '2026-03-30', // Fecha futura
                financials: { contractValue: 350000, projectedCost: 290000, actualCost: 0 },
                team: [
                    { role: 'Jefe de Obra', name: 'Ricardo P.' },
                    { role: 'Alba√±il', count: 6 },
                    { role: 'Fontanero', count: 2 }
                ]
            },
            {
                id: 8,
                name: 'Hotel Boutique Sarri√†',
                client: 'Arquitectura Moderna BCN',
                color: '#16a085',
                storage: 0, // A√∫n no ha empezado, no gasta almac√©n
                materials: [],
                startDate: '2026-01-01', // Fecha futura
                endDate: '2026-06-30',
                financials: { contractValue: 220000, projectedCost: 180000, actualCost: 0 },
                team: [
                    { role: 'Jefe de Obra', name: 'Ana G.' },
                    { role: 'Alba√±il', count: 4 },
                    { role: 'Electricista', count: 3 },
                    { role: 'Carpintero', count: 2 }
                ]
            }
        ];
        
        // Datos de Empresas de Alquiler
        const rentalCompanies = [
            { name: 'Sixt', logo: 'üî¥', prices: { small: { min: 28, max: 42 }, medium: { min: 35, max: 58 }, large: { min: 45, max: 65 }, truck: { min: 75, max: 95 } } },
            { name: 'Europcar', logo: 'üü¢', prices: { small: { min: 25, max: 38 }, medium: { min: 32, max: 52 }, large: { min: 42, max: 62 }, truck: { min: 70, max: 90 } } },
            { name: 'Hertz', logo: 'üü°', prices: { small: { min: 30, max: 45 }, medium: { min: 38, max: 60 }, large: { min: 48, max: 68 }, truck: { min: 80, max: 100 } } },
            { name: 'Enterprise', logo: 'üü§', prices: { small: { min: 26, max: 40 }, medium: { min: 33, max: 55 }, large: { min: 43, max: 63 }, truck: { min: 72, max: 92 } } }
        ];

        // Datos de Industriales (sus asignaciones se actualizar√°n din√°micamente)
        const provinces = [
            {
                name: 'Barcelona',
                icon: 'üèôÔ∏è',
                workers: [
                    { name: 'Marc Puigdemont', role: 'Electricista', rate: 28, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' },
                    { name: 'Laura Su√°rez', role: 'Electricista', rate: 26, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Jordi Vila', role: 'Electricista', rate: 27, status: 'busy', project: 'Loft Sant Antoni' },
                    { name: 'Anna Compte', role: 'Electricista', rate: 25, status: 'available', project: null },
                    { name: 'Pere Mart√≠nez', role: 'Fontanero', rate: 24, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' },
                    { name: 'Marta Vidal', role: 'Fontanero', rate: 23, status: 'busy', project: 'Vivienda Eixample' },
                    { name: 'Josep Roca', role: 'Fontanero', rate: 25, status: 'available', project: null },
                    { name: 'Carles Font', role: 'Alba√±il', rate: 22, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' },
                    { name: 'S√≤nia Mir√≥', role: 'Alba√±il', rate: 21, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' },
                    { name: 'David Torres', role: 'Alba√±il', rate: 20, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' },
                    { name: 'Mireia Casals', role: 'Alba√±il', rate: 22, status: 'busy', project: 'Vivienda Eixample' },
                    { name: 'Xavier Pons', role: 'Alba√±il', rate: 21, status: 'busy', project: 'Vivienda Eixample' },
                    { name: 'N√∫ria Soler', role: 'Alba√±il', rate: 20, status: 'available', project: null },
                    { name: 'Ricardo P.', role: 'Jefe de Obra', rate: 45, status: 'busy', project: 'Residencial Les Corts' } // A√±adido
                ]
            },
            {
                name: 'Girona',
                icon: 'üèîÔ∏è',
                workers: [
                    { name: 'Albert Mas', role: 'Alba√±il', rate: 21, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Montse Bosch', role: 'Alba√±il', rate: 22, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Francesc Colomer', role: 'Alba√±il', rate: 20, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Rosa Pla', role: 'Carpintero', rate: 24, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Enric Sala', role: 'Carpintero', rate: 23, status: 'busy', project: 'Apartamentos Platja d\'Aro' },
                    { name: 'Silvia Blanc', role: 'Carpintero', rate: 22, status: 'available', project: null },
                    { name: 'Carlos R.', role: 'Jefe de Obra', rate: 42, status: 'busy', project: 'Apartamentos Platja d\'Aro' } // A√±adido
                ]
            },
            {
                name: 'Lleida',
                icon: 'üåæ',
                workers: [
                    { name: 'Ramon Sol√©', role: 'Pintor', rate: 19, status: 'busy', project: 'Reforma Oficinas Tech Park' },
                    { name: 'Cristina Mora', role: 'Pintor', rate: 18, status: 'busy', project: 'Reforma Oficinas Tech Park' },
                    { name: 'Llu√≠s Bernabeu', role: 'Pintor', rate: 20, status: 'busy', project: 'Vivienda Eixample' },
                    { name: 'Teresa Oliv√©', role: 'Pintor', rate: 19, status: 'available', project: null }
                ]
            },
            {
                name: 'Tarragona',
                icon: 'üåä',
                workers: [
                    { name: 'Oriol Ferrer', role: 'Carpintero', rate: 23, status: 'available', project: null },
                    { name: 'Gemma Roig', role: 'Pintor', rate: 19, status: 'busy', project: 'Vivienda Eixample' },
                    { name: 'Pau Sancho', role: 'Pintor', rate: 20, status: 'busy', project: 'Loft Sant Antoni' },
                    { name: 'Aina Rabassa', role: 'Pe√≥n', rate: 16, status: 'busy', project: 'Loft Sant Antoni' },
                    { name: 'Ana G.', role: 'Jefe de Obra', rate: 43, status: 'busy', project: 'Reforma Integral c/ Diagonal 420' } // A√±adido
                ]
            }
        ];

        let currentFile = null;
        
        // Variables de datos din√°micos (se rellenar√°n al cargar)
        let projectData = [];
        let provinceData = [];

        // =================================================================================
        // L√ìGICA DE INICIALIZACI√ìN Y COHERENCIA DE DATOS
        // =================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Actualizar estados de proyectos basado en TODAY
            projectData = updateProjectStatus(projects, TODAY);
            
            // 2. Actualizar estados de trabajadores basado en los proyectos
            provinceData = updateWorkerStatus(provinces, projectData);

            // 3. Renderizar todos los componentes con los datos coherentes
            renderDynamicStats(projectData, provinceData);
            renderStorageVisualization(projectData);
            renderTransportSchedule();
            renderRentalCompanies();
            renderWorkersGrid(provinceData);
            renderTimeline(projectData);
            
            // 4. Cargar tema y hora inicial
            loadTheme();
            document.getElementById('init-time').textContent = TODAY.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        });

        /**
         * Actualiza el estado y progreso de los proyectos basado en la fecha actual (TODAY)
         */
        function updateProjectStatus(projectList, today) {
            projectList.forEach(p => {
                const startDate = new Date(p.startDate);
                const endDate = new Date(p.endDate);

                if (today < startDate) {
                    p.status = 'scheduled';
                    p.progress = 0;
                } else if (today >= startDate && today <= endDate) {
                    p.status = 'active';
                    // Calcular progreso realista
                    const totalDuration = endDate.getTime() - startDate.getTime();
                    const elapsedDuration = today.getTime() - startDate.getTime();
                    p.progress = Math.min(95, Math.max(5, Math.floor((elapsedDuration / totalDuration) * 100))); // Capado a 95% si est√° activo
                } else { // today > endDate
                    p.status = 'completed';
                    p.progress = 100;
                }
            });
            return projectList;
        }

        /**
         * Actualiza el estado de los trabajadores basado en el estado de sus proyectos asignados
         */
        function updateWorkerStatus(provinceList, projectList) {
            provinceList.forEach(province => {
                province.workers.forEach(worker => {
                    if (worker.project) {
                        const assignedProject = projectList.find(p => p.name === worker.project);
                        if (assignedProject && assignedProject.status === 'active') {
                            worker.status = 'busy';
                        } else {
                            // Si el proyecto est√° completado, programado, o no se encuentra
                            worker.status = 'available';
                            worker.project = null; // Liberar al trabajador
                        }
                    } else {
                        worker.status = 'available';
                    }
                });
            });
            return provinceList;
        }

        // =================================================================================
        // THEME
        // =================================================================================

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('theme-text').textContent = newTheme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
            
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
                document.getElementById('theme-text').textContent = 'Modo Claro';
            }
        }

        // =================================================================================
        // NAVEGACI√ìN (TABS Y TARJETAS)
        // =================================================================================
        
        /**
         * CORRECCI√ìN CR√çTICA:
         * Esta funci√≥n maneja la navegaci√≥n por pesta√±as.
         * Acepta un 'clickedElement' (cuando se hace clic en una pesta√±a) o
         * funciona program√°ticamente (cuando se llama desde una tarjeta de estad√≠sticas).
         * Esto corrige el error 'Cannot read properties of null (reading 'classList')'.
         */
        function switchTab(tabName, clickedElement = null) {
            // Desactivar todas las pesta√±as y contenidos
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            let tabToActivate;
            if (clickedElement) {
                // Se hizo clic en un bot√≥n de pesta√±a
                tabToActivate = clickedElement;
            } else {
                // Se llam√≥ program√°ticamente (desde una tarjeta), buscar el bot√≥n por data-tab
                tabToActivate = document.querySelector(`.tab[data-tab="${tabName}"]`);
            }

            if (tabToActivate) {
                tabToActivate.classList.add('active');
            }
            
            const contentToActivate = document.getElementById(`tab-${tabName}`);
            if (contentToActivate) {
                contentToActivate.classList.add('active');
            }
        }

        // Acciones de las tarjetas de estad√≠sticas
        function openStorageDetails() {
            switchTab('almacenamiento'); // Llama a la funci√≥n corregida
            scrollToElement('tab-almacenamiento');
        }

        function openWorkersDetails() {
            switchTab('industriales'); // Llama a la funci√≥n corregida
            scrollToElement('tab-industriales');
        }

        function openTransportDetails() {
            switchTab('transporte'); // Llama a la funci√≥n corregida
            scrollToElement('tab-transporte');
        }
        
        function scrollToElement(elementId) {
             setTimeout(() => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100); // Peque√±o retraso para asegurar que el tab est√° visible
        }

        function openBillingDetails() {
            const billingInfo = `
                <strong>üí∞ Desglose Financiero Detallado - ${TODAY.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}:</strong><br><br>
                
                <strong>üìä INGRESOS POR CLIENTE (Activos):</strong><br>
                ‚Ä¢ Construcciones Mart√≠nez: 4.050‚Ç¨/mes (Proyecto: Residencial Les Corts)<br>
                <strong>Total ingresos (Proyectos activos): 4.050‚Ç¨/mes</strong><br><br>
                
                <strong>üìâ GASTOS OPERATIVOS:</strong><br>
                ‚Ä¢ N√≥minas personal (27 trabajadores): 4.200‚Ç¨<br>
                ‚Ä¢ Alquiler almac√©n (calculado): 304‚Ç¨ (Basado en 38m¬≥ ocupados a 8‚Ç¨/m¬≥)<br>
                ‚Ä¢ Alquiler transporte (media): 380‚Ç¨<br>
                ‚Ä¢ Seguros y licencias: 420‚Ç¨<br>
                ‚Ä¢ Materiales y suministros (media): 1.250‚Ç¨<br>
                <strong>Total gastos: 6.554‚Ç¨</strong><br><br>
                
                <strong>üí∏ IMPUESTOS (Estimaci√≥n):</strong><br>
                ‚Ä¢ IVA (21% sobre ingresos): 850.50‚Ç¨<br>
                ‚Ä¢ IRPF (media 25% s/ n√≥minas): 1.050‚Ç¨<br>
                <strong>Total impuestos: 1.900.50‚Ç¨</strong><br><br>
                
                <strong style="font-size: 18px; color: var(--danger);">üö® D√âFICIT OPERATIVO ACTUAL: -2.504‚Ç¨/mes</strong><br><br>
                
                <em>Nota: El d√©ficit es normal ya que solo hay 1 proyecto grande activo. Los proyectos completados (p.ej. Diagonal, Platja d'Aro) generaron beneficios en meses anteriores. El proyecto 'Hotel Boutique Sarri√†' (220k‚Ç¨) comenzar√° en Enero 2026.</em>
            `;
            
            addMessage(billingInfo, 'assistant');
        }
        
        // =================================================================================
        // RENDERIZADO DE COMPONENTES
        // =================================================================================
        
        /**
         * Renderiza los valores de las tarjetas de estad√≠sticas din√°micamente
         */
        function renderDynamicStats(projectList, provinceList) {
            // Almacenamiento
            const activeProjects = projectList.filter(p => p.status === 'active');
            const usedSpace = activeProjects.reduce((sum, p) => sum + p.storage, 0);
            document.getElementById('stat-storage-value').textContent = `${usedSpace}m¬≥`;
            document.getElementById('stat-storage-subtitle').textContent = `de 100m¬≥ ocupados`;

            // Trabajadores
            const allWorkers = provinceList.flatMap(p => p.workers);
            const busyWorkers = allWorkers.filter(w => w.status === 'busy').length;
            const availableWorkers = allWorkers.filter(w => w.status === 'available').length;
            document.getElementById('stat-workers-value').textContent = busyWorkers;
            document.getElementById('stat-workers-subtitle').textContent = `de ${allWorkers.length} industriales`;
            document.getElementById('stat-workers-trend-val').textContent = `‚Üì ${availableWorkers}`;
            document.getElementById('stat-workers-trend-text').textContent = `disponibles`;
        }


        /**
         * Renderiza la visualizaci√≥n del almac√©n
         */
        function renderStorageVisualization(projectList) {
            const container = document.getElementById('storage-visualization');
            
            const totalCapacity = 100;
            // Solo contar almacenamiento de proyectos ACTIVOS
            const activeProjects = projectList.filter(p => p.status === 'active' && p.storage > 0);
            const usedSpace = activeProjects.reduce((sum, p) => sum + p.storage, 0);
            const freeSpace = totalCapacity - usedSpace;

            let html = `
                <div class="storage-container">
                    <div class="storage-header">
                        <div class="storage-stats">
                            <div class="storage-stat-item">
                                <label>Ocupado (Proyectos Activos)</label>
                                <span style="color: var(--primary);">${usedSpace}m¬≥</span>
                            </div>
                            <div class="storage-stat-item">
                                <label>Libre</label>
                                <span style="color: var(--success);">${freeSpace}m¬≥</span>
                            </div>
                            <div class="storage-stat-item">
                                <label>Total</label>
                                <span>${totalCapacity}m¬≥</span>
                            </div>
                        </div>
                    </div>
                    <div class="storage-visual">
            `;

            activeProjects.forEach(project => {
                const widthPercent = (project.storage / totalCapacity) * 100;
                html += `
                    <div class="storage-section" style="width: ${widthPercent}%;" onclick="openProjectModal(${project.id})">
                        <div class="storage-project-block" style="background: ${project.color};">
                            ${project.name}<br>(${project.storage}m¬≥)
                        </div>
                    </div>
                `;
            });

            if (freeSpace > 0) {
                const widthPercent = (freeSpace / totalCapacity) * 100;
                html += `
                    <div class="storage-section" style="width: ${widthPercent}%;">
                        <div class="storage-project-block storage-empty">
                            ${freeSpace}m¬≥<br>Libre
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        /**
         * Renderiza el calendario de transporte, usando la fecha global TODAY
         */
        function renderTransportSchedule() {
            const container = document.getElementById('transport-schedule');
            const today = TODAY; // Usa la fecha global
            const days = [];
            
            // Mostrar los pr√≥ximos 7 d√≠as desde TODAY
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }

            let html = '<div class="transport-schedule">';

            days.forEach(date => {
                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                
                html += `
                    <div class="schedule-day">
                        <div class="day-header">
                            <span>${dayName}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">Furgoneta propia</span>
                        </div>
                        <div class="hours-grid">
                            <div class="hour-label">Horas</div>
                `;

                for (let hour = 0; hour < 24; hour++) {
                    const random = Math.random();
                    let className = 'hour-free';
                    let tooltip = 'Libre';

                    if (hour >= 8 && hour <= 18) {
                        if (random > 0.6) {
                            className = 'hour-busy-own';
                            tooltip = 'Ocupado - Veh√≠culo propio (Proyecto: Residencial Les Corts)';
                        } else if (random > 0.3) {
                            className = 'hour-busy-rental';
                            const rentalType = random > 0.45 ? 'Mediana' : 'Peque√±a';
                            const price = random > 0.45 ? '35‚Ç¨' : '28‚Ç¨';
                            tooltip = `Alquiler - Furgoneta ${rentalType} - ${price}`;
                        }
                    }

                    html += `
                        <div class="hour-cell ${className} tooltip" data-tooltip="${hour}:00 - ${tooltip}"></div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        /**
         * Renderiza las tarjetas de empresas de alquiler
         */
        function renderRentalCompanies() {
            const container = document.getElementById('rental-companies');
            let html = '<div class="rental-companies">';

            rentalCompanies.forEach(company => {
                html += `
                    <div class="rental-company-card clickable" onclick="openRentalModal('${company.name}')">
                        <div class="company-logo">${company.logo} ${company.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                            Precios actualizados - ${TODAY.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                        </div>
                        <div class="company-prices">
                            <div class="price-row">
                                <span>Peque√±a (3-5m¬≥)</span>
                                <strong>${company.prices.small.min}-${company.prices.small.max}‚Ç¨/d√≠a</strong>
                            </div>
                            <div class="price-row">
                                <span>Mediana (6-10m¬≥)</span>
                                <strong>${company.prices.medium.min}-${company.prices.medium.max}‚Ç¨/d√≠a</strong>
                            </div>
                            <div class="price-row">
                                <span>Grande (11-15m¬≥)</span>
                                <strong>${company.prices.large.min}-${company.prices.large.max}‚Ç¨/d√≠a</strong>
                            </div>
                            <div class="price-row">
                                <span>Cami√≥n (>15m¬≥)</span>
                                <strong>${company.prices.truck.min}-${company.prices.truck.max}‚Ç¨/d√≠a</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        /**
         * Renderiza la parrilla de trabajadores, usando los datos din√°micos
         */
        function renderWorkersGrid(provinceList) {
            const container = document.getElementById('workers-grid');
            let html = '';

            provinceList.forEach((province, idx) => {
                const available = province.workers.filter(w => w.status === 'available').length;
                const busy = province.workers.filter(w => w.status === 'busy').length;

                html += `
                    <div class="province-section">
                        <div class="province-header" onclick="toggleProvince(${idx})">
                            <div class="province-name">
                                <span>${province.icon}</span>
                                <span>${province.name}</span>
                            </div>
                            <div class="province-stats">
                                <span style="color: var(--success);">${available} disponibles</span>
                                <span style="color: var(--danger);">${busy} ocupados</span>
                                <span class="expand-icon" id="province-icon-${idx}">‚ñº</span>
                            </div>
                        </div>
                        <div class="workers-list" id="province-workers-${idx}">
                            ${province.workers.map(worker => {
                                const initials = worker.name.split(' ').map(n => n[0]).join('');
                                const avatarColor = worker.status === 'available' ? 'var(--success)' : 'var(--danger)';
                                
                                return `
                                    <div class="worker-card" data-status="${worker.status}">
                                        <div class="worker-info">
                                            <div class="worker-avatar" style="background: ${avatarColor};">
                                                ${initials}
                                            </div>
                                            <div class="worker-details">
                                                <h4>${worker.name}</h4>
                                                <div class="worker-meta">
                                                    <span>${worker.role}</span>
                                                    ${worker.project ? `<span>‚Ä¢</span><span>${worker.project}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="worker-status">
                                            <div class="availability-badge badge-${worker.status === 'available' ? 'available' : 'busy'}">
                                                ${worker.status === 'available' ? 'Disponible' : 'Ocupado'}
                                            </div>
                                            <div class="worker-rate">${worker.rate}‚Ç¨/h</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleProvince(idx) {
            const container = document.getElementById(`province-workers-${idx}`);
            const icon = document.getElementById(`province-icon-${idx}`);
            
            container.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function filterWorkers(clickedElement, filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            clickedElement.classList.add('active');

            document.querySelectorAll('.worker-card').forEach(card => {
                const status = card.getAttribute('data-status');
                if (filter === 'all' || status === filter) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        /**
         * Renderiza el timeline, usando datos y fecha global
         */
        function renderTimeline(projectList) {
            const container = document.getElementById('timeline-grid');
            const startDate = new Date('2024-07-01');
            const endDate = new Date('2026-06-30');
            const today = TODAY; // Usar fecha global
            
            const months = [];
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                months.push({
                    label: `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear().toString().slice(2)}`,
                    date: new Date(currentDate)
                });
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const daysSinceStart = (today - startDate) / (1000 * 60 * 60 * 24);
            const todayPercent = (daysSinceStart / totalDays) * 100;
            const todayLabel = `HOY - ${today.toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'})}`;

            let html = `
                <div class="timeline-months">
                    <div style="grid-column: 1; text-align: left; padding-left: 8px; font-weight: 600;">Proyecto</div>
                    ${months.map(m => `<div class="month-label">${m.label}</div>`).join('')}
                </div>
                <div style="position: relative;">
                    <div class="timeline-today-marker" style="left: ${todayPercent}%;">
                        <div class="timeline-today-label">${todayLabel}</div>
                    </div>
            `;

            projectList.forEach(project => {
                const projectStart = new Date(project.startDate);
                const projectEnd = new Date(project.endDate);
                
                const startDays = (projectStart - startDate) / (1000 * 60 * 60 * 24);
                const endDays = (projectEnd - startDate) / (1000 * 60 * 60 * 24);
                
                const startPercent = Math.max(0, (startDays / totalDays) * 100);
                const widthPercent = ((endDays - startDays) / totalDays) * 100;

                let statusBadge = '';
                let statusColor = project.color;
                
                // Usar el estado din√°mico (p.status)
                if (project.status === 'completed') {
                    statusBadge = '‚úì Completado';
                    statusColor = 'var(--success)';
                } else if (project.status === 'active') {
                    statusBadge = `${project.progress}% en curso`;
                    statusColor = 'var(--primary)'; // Color coherente para "en curso"
                } else {
                    statusBadge = 'Programado';
                    statusColor = 'var(--warning)';
                }

                html += `
                    <div class="timeline-row">
                        <div class="project-label" title="${project.name}">${project.name}</div>
                        <div class="project-bar-container">
                            <div class="project-bar" 
                                 style="left: ${startPercent}%; width: ${widthPercent}%; background: ${statusColor};"
                                 onclick="openProjectModal(${project.id})"
                                 title="${project.name} (${project.client})">
                                ${project.client}
                                <span class="project-status-badge">${statusBadge}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        // =================================================================================
        // MODALS (CON DATOS ENRIQUECIDOS)
        // =================================================================================

        function openProjectModal(projectId) {
            // Usar projectData que tiene el estado actualizado
            const project = projectData.find(p => p.id === projectId);
            if (!project) return;

            document.getElementById('modal-project-title').textContent = project.name;
            document.getElementById('modal-project-client').textContent = `Cliente: ${project.client}`;
            
            const content = document.getElementById('modal-project-content');
            
            // Calcular finanzas
            const fin = project.financials;
            let cost, profit, margin, costLabel, profitLabel;

            if (project.status === 'completed') {
                cost = fin.actualCost;
                profit = fin.contractValue - fin.actualCost;
                costLabel = 'Coste Final';
                profitLabel = 'Beneficio Final';
            } else if (project.status === 'active') {
                cost = fin.projectedCost; // Usar proyectado
                profit = fin.contractValue - fin.projectedCost;
                costLabel = 'Coste Proyectado';
                profitLabel = 'Beneficio Estimado';
            } else { // scheduled
                cost = fin.projectedCost;
                profit = fin.contractValue - fin.projectedCost;
                costLabel = 'Coste Proyectado';
                profitLabel = 'Beneficio Estimado';
            }
            margin = (profit / fin.contractValue) * 100;

            // Formatear moneda
            const formatMoney = (val) => val.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });

            content.innerHTML = `
                <div class="modal-section">
                    <h4>üìä Informaci√≥n del Proyecto</h4>
                    <div class="material-list">
                        <div class="material-item">
                            <span class="material-name">Estado</span>
                            <span class="material-quantity" style="font-weight: 600; color: ${project.status === 'completed' ? 'var(--success)' : project.status === 'active' ? 'var(--primary)' : 'var(--warning)'};">
                                ${project.status === 'completed' ? 'Completado' : project.status === 'active' ? 'En curso' : 'Programado'}
                            </span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Progreso</span>
                            <span class="material-quantity">${project.progress}%</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Espacio ocupado</span>
                            <span class="material-quantity">${project.storage > 0 ? project.storage + ' m¬≥' : 'N/A'}</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Fecha inicio</span>
                            <span class="material-quantity">${new Date(project.startDate).toLocaleDateString('es-ES')}</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Fecha fin ${project.status === 'completed' ? '' : 'estimada'}</span>
                            <span class="material-quantity">${new Date(project.endDate).toLocaleDateString('es-ES')}</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>üí∞ Resumen Financiero</h4>
                    <div classs="material-list">
                        <div class="material-item">
                            <span class="material-name">Valor Contrato</span>
                            <span class="material-quantity" style="font-weight: 600;">${formatMoney(fin.contractValue)}</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">${costLabel}</span>
                            <span class="material-quantity">${formatMoney(cost)}</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">${profitLabel}</span>
                            <span class="material-quantity" style="color: var(--success); font-weight: 600;">${formatMoney(profit)}</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">Margen</span>
                            <span class="material-quantity" style="color: var(--primary); font-weight: 600;">${margin.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>üë∑ Equipo Asignado</h4>
                    <div class="material-list">
                        ${project.team.map(t => `
                            <div class="material-item">
                                <span class="material-name">${t.role}</span>
                                <span class="material-quantity">${t.name ? t.name : `${t.count} ${t.count > 1 ? 'industriales' : 'industrial'}`}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${project.materials.length > 0 ? `
                    <div class="modal-section">
                        <h4>üì¶ Materiales Almacenados</h4>
                        <div class="material-list">
                            ${project.materials.map(m => `
                                <div class="material-item">
                                    <span class="material-name">${m.name}</span>
                                    <span class="material-quantity">${m.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Proyecto en fase de planificaci√≥n - materiales pendientes</div>`}
            `;
            
            document.getElementById('project-modal').classList.add('active');
        }

        function openRentalModal(companyName) {
            const company = rentalCompanies.find(c => c.name === companyName);
            if (!company) return;

            document.getElementById('modal-rental-title').textContent = `${company.logo} ${company.name}`;
            
            const content = document.getElementById('modal-rental-content');
            content.innerHTML = `
                <div class="modal-section">
                    <h4>üí∞ Tarifas Detalladas</h4>
                    <div class="material-list">
                        <div class="material-item">
                            <span class="material-name">üöó Furgoneta Peque√±a (3-5 m¬≥)</span>
                            <span class="material-quantity">${company.prices.small.min}-${company.prices.small.max}‚Ç¨/d√≠a</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">üöô Furgoneta Mediana (6-10 m¬≥)</span>
                            <span class="material-quantity">${company.prices.medium.min}-${company.prices.medium.max}‚Ç¨/d√≠a</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">üöö Furgoneta Grande (11-15 m¬≥)</span>
                            <span class="material-quantity">${company.prices.large.min}-${company.prices.large.max}‚Ç¨/d√≠a</span>
                        </div>
                        <div class="material-item">
                            <span class="material-name">üöõ Cami√≥n (>15 m¬≥)</span>
                            <span class="material-quantity">${company.prices.truck.min}-${company.prices.truck.max}‚Ç¨/d√≠a</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>‚ÑπÔ∏è Informaci√≥n Adicional</h4>
                    <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                        <p style="margin-bottom: 8px;">‚Ä¢ Precios actualizados a ${TODAY.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</p>
                        <p style="margin-bottom: 8px;">‚Ä¢ Incluye seguro b√°sico a terceros</p>
                        <p style="margin-bottom: 8px;">‚Ä¢ Kilometraje ilimitado en territorio nacional</p>
                        <p style="margin-bottom: 8px;">‚Ä¢ Posibilidad de conductor adicional (+15‚Ç¨/d√≠a)</p>
                        <p>‚Ä¢ Descuentos por alquileres superiores a 7 d√≠as</p>
                    </div>
                </div>
            `;
            
            document.getElementById('rental-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // =================================================================================
        // CHAT (USANDO DATOS DIN√ÅMICOS)
        // =================================================================================

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFile = file;
            const preview = document.getElementById('file-preview-container');
            preview.innerHTML = `
                <div class="file-preview">
                    <span>üìÑ</span>
                    <span>${file.name}</span>
                    <span class="file-remove" onclick="removeFile()">‚úï</span>
                </div>
            `;
        }

        function removeFile() {
            currentFile = null;
            document.getElementById('file-preview-container').innerHTML = '';
            document.getElementById('file-upload').value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message && !currentFile) return;

            addMessage(message || `üìÑ ${currentFile.name}`, 'user');
            input.value = '';
            input.style.height = 'auto';

            let fileContent = '';
            if (currentFile) {
                fileContent = await readFile(currentFile);
                removeFile();
            }

            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                // Pasar los datos din√°micos al procesador de mensajes
                const response = processMessage(message, fileContent, projectData, provinceData);
                addMessage(response, 'assistant');
            }, 1200);
        }

        function addMessage(text, type) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            messageDiv.innerHTML = `
                <div>${text.replace(/\n/g, '<br>')}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function readFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsText(file);
            });
        }

        /**
         * Procesador de IA (simulado) que usa datos din√°micos
         */
        function processMessage(message, fileContent, projects, provinces) {
            const msgLower = message.toLowerCase();

            // Disponibilidad
            if (msgLower.includes('disponib') || msgLower.includes('libre')) {
                const availableWorkers = provinces.flatMap(p => p.workers).filter(w => w.status === 'available');
                const activeProjects = projects.filter(p => p.status === 'active');
                const usedSpace = activeProjects.reduce((sum, p) => sum + p.storage, 0);
                const freeSpace = 100 - usedSpace;
                
                let response = `<strong>üìä Recursos Disponibles (a ${TODAY.toLocaleDateString('es-ES')}):</strong>\n\n`;
                response += `<strong>Almac√©n:</strong> ${freeSpace} m¬≥ libres de 100 m¬≥\n`;
                response += `<strong>Personal disponible:</strong> ${availableWorkers.length} de ${provinces.flatMap(p => p.workers).length} industriales\n\n`;
                
                provinces.forEach(p => {
                    const available = p.workers.filter(w => w.status === 'available');
                    if(available.length > 0) {
                        response += `<strong>${p.icon} ${p.name}:</strong> ${available.map(w => `${w.name} (${w.role})`).join(', ')}\n`;
                    }
                });
                return response;
            }

            // Barcelona espec√≠fico
            if (msgLower.includes('barcelona')) {
                const bcnWorkers = provinces.find(p => p.name === 'Barcelona').workers;
                const available = bcnWorkers.filter(w => w.status === 'available');
                
                if (msgLower.includes('electric')) {
                    const electricistas = available.filter(w => w.role === 'Electricista');
                    return `
                        <strong>‚ö° Electricistas en Barcelona:</strong>\n\n
                        ${electricistas.length > 0 ? 
                            'Disponibles:\n' + electricistas.map(w => `‚Ä¢ ${w.name} - ${w.rate}‚Ç¨/h`).join('\n') :
                            'Todos los electricistas est√°n ocupados actualmente.'
                        }\n\n
                        Total electricistas Barcelona: ${bcnWorkers.filter(w => w.role === 'Electricista').length}
                    `;
                }
                
                return `
                    <strong>üèôÔ∏è Personal en Barcelona:</strong>\n\n
                    <strong>Disponibles (${available.length}):</strong>\n
                    ${available.length > 0 ? available.map(w => `‚Ä¢ ${w.name} (${w.role}) - ${w.rate}‚Ç¨/h`).join('\n') : 'Ninguno disponible'}\n\n
                    <strong>Ocupados (${bcnWorkers.length - available.length}):</strong>\n
                    ${bcnWorkers.filter(w => w.status === 'busy').map(w => `‚Ä¢ ${w.name} en ${w.project}`).join('\n')}
                `;
            }

            // Proyectos
            if (msgLower.includes('proyecto')) {
                const activeProjects = projects.filter(p => p.status === 'active');
                return `
                    <strong>üìã Proyectos Activos (${activeProjects.length}):</strong>\n\n
                    ${activeProjects.map(p => `
                        <strong>${p.name}</strong>
                        Cliente: ${p.client}
                        Progreso: ${p.progress}%
                        Almac√©n: ${p.storage}m¬≥
                        Fin Estimado: ${new Date(p.endDate).toLocaleDateString('es-ES')}
                    `).join('\n\n')}
                    \n\n<em>Haz click en las barras del timeline para ver el desglose financiero y de equipo.</em>
                `;
            }

            // Financiero
            if (msgLower.includes('financ') || msgLower.includes('factura') || msgLower.includes('dinero') || msgLower.includes('beneficio')) {
                return `
                    <strong>üí∞ Resumen Financiero:</strong>\n\n
                    Actualmente, los gastos operativos (6.554‚Ç¨/mes) son mayores que los ingresos de proyectos activos (4.050‚Ç¨/mes), resultando en un d√©ficit operativo de -2.504‚Ç¨.\n\n
                    Esto es normal mientras el proyecto "Residencial Les Corts" est√° en su fase inicial.\n\n
                    Los proyectos completados este a√±o (como 'Diagonal 420' y 'Platja d\'Aro') han generado un beneficio total de <strong>46.000‚Ç¨</strong>.\n\n
                    <em>Haz click en la tarjeta "Facturaci√≥n" para ver el desglose detallado.</em>
                `;
            }

            // Gen√©rico
            return `
                Puedo ayudarte con:\n\n
                ‚Ä¢ "¬øQu√© recursos est√°n disponibles?"\n
                ‚Ä¢ "¬øCu√°ntos electricistas tenemos en Barcelona?"\n
                ‚Ä¢ "Mu√©strame los proyectos activos"\n
                ‚Ä¢ "¬øCu√°l es el beneficio neto?"\n
                ‚Ä¢ "¬øQu√© personal est√° ocupado?"\n\n
                ¬øQu√© necesitas saber?
            `;
        }

        // Auto-resize textarea
        const textarea = document.getElementById('chat-input');
        if(textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>